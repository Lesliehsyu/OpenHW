---
layout: post
title:  "智能屋盖开合系统"
author: XUP-2019
categories: [ project, 2019competition ]
image: assets/images/2019_2_3/cover.png
---

![isolution]({{ site.baseurl }}/assets/images/all_white.jpg)

**王兴，李力行，方逸之**

[视频链接](http://player.youku.com/embed/XNDUyNjAzNjMyMA==)

**第一部分 设计概述**

&nbsp;

**1.1 设计目的**

开合屋盖又称为活动屋盖、移动天幕等，是一种在短时间内部分或者全部屋盖可以 移动或开合的结构形式，它使得建筑物在屋顶开启和闭合两个状态下都可以使用。 

**1.2 应用领域**

现代开合屋盖系统综合了建筑、结构、机械、控制等多领域的技术成果，使得建筑 可以最大限度地利用自然采光、通风，创造贴近自然的敞开式运动环境，同时避免了恶 劣天气对使用功能的不利影响。 

**1.3 主要技术特点**

本组大型体育场开合屋盖采取了组合空间移动方式进行结构开合设计，即折叠式与 绕枢轴转动式。开合结构体块单元采用桁架网格与轻质刚性薄板组合，以保证单元的刚 度变形以及后期深入效果展示的实现（如薄板与建筑 LED 屏结合），通过高强度转动轴 连接不同体块以确保整体结构的稳定性，主转动轴圆盘后半部设计采用高密度材料以控 制整个悬出结构重心在转动中轴上以传递荷载给基础。通过两次不同形式的开合展开， 将整个大型体育场最大程度地展开呈现，在满足功能性安全性的基础上，完成美观艺术 效果的设计。 

**1.4 关键性能指标**

模型模组：6 组 

模型净重：400g/组 

开启速度：2s 左右/组 

闭合速度：2s 左右/组 

温度精度：1 摄氏度

温度范围：0-50 摄氏度 

湿度精度：1% 

湿度范围：10%-90% 

感器采样周期：2s 

响应时间：小于 1ms 

ESP 与 FPGA 通信周期：2s

&nbsp;

**第二部分 系统组成及功能说明**

&nbsp;

**2.1 整体介绍**

![image_1]({{ site.baseurl }}/assets/images/2019_2_3/image_1.png)

**2.2 各模块介绍**

2.2.1 传感器及自动控制模块

本系统使用的传感器有一个温湿度传感器 DHT11 四个光照传感器 GY-30， 自动控制的开启和关闭直接用 SPI 写入。利用 ESP32 输出，FPGA 输入来进行控 制。ESP32 端则是根据 WiFi 传输过来的数据来确定是输出高电平还是低电平。 剩下将就两个传感器来说明。 

温湿度传感器 DHT 使用的是中间的单数据总线，先发送 20ms 低电平激活 模块，然后模块会发送 40bit 的数据，MSB 先传输，数据为 DATA[39:0] = {Humidity[15:0], Temperature[15:0], Check[7:0]}。其时序图如图 2 所示。其中数 据&rsquo;0&rsquo;为拉高 26~28&mu;s，数据&rsquo;1&rsquo;为拉高 70&mu;s，我使用的判断方法是看其拉高时长 是否大于 40&mu;s，大于即为&rsquo;1&rsquo;，小于即为&rsquo;0&rsquo;。

![image_2]({{ site.baseurl }}/assets/images/2019_2_3/image_2.png)

由于 DHT11 的精度问题，所以只有湿度和温度的前 8 位有效，后面全为 0。 传输出来温湿度直接各保存为 8bit 数据保存，2s 获取一次数据，供 ESP32 端读 取上传和自动控制时的逻辑判断。 

光照传感器模块 GY30 主要使用的是 BH1750FVI 芯片，这是一个通过 I2C 总线读取的 16bit 光照传感器，其时序图如图 4 所示。

![image_3]({{ site.baseurl }}/assets/images/2019_2_3/image_3.png)

我们使用的是 One Time H-Resolution Mode，所以根据 datasheet 发送的指令 应为 0010_0000。根据 datasheet 还需要除 1.2，这个则直接在 ESP32 端处理后发 送到服务器上。 

自动控制部分，利用的是 ESP_FPGA&mdash;QSPI 的 QSPI_HD 接口，高电平对应&rsquo;On&rsquo;，低电平对应&rsquo;Off&rsquo;。 开启情况下有自动控制。 WiFi 通讯模块 

WiFi 通讯模块

主要是利用 esp32 的 WiFi 功能，通 过 SPI 总线和 FPGA 端通信以控制是否自动控制、开 合度和开合速度、读取传感器数值和在自动模式下检 测开合度。可以分成 2 个小部分来介绍。

首先是 esp32 通过 MQTT 服务器和手机通讯。手 机端使用的 APP 是 IoT MQTT Panel(ver:0.37(Beta), 下 载于 Google Play)，我们设计的手机端界面如图 5 所示。 

![image_4]({{ site.baseurl }}/assets/images/2019_2_3/image_4.png)

esp32 端 则 使 用 了 开 源 的 umqtt.simple 的 micropython 库，连接手机热点后订阅相应的 Title 后读 取 FPGA 获得的传感器数值上传，同时根据订阅获得 速度、开合度数值是否自动控制并传输到 FPGA 进行 控制。 

然后是 esp32 和 FPGA 端的通讯。这个通讯我选择 的是 SPI 总线，因为 SPI 总线的速度能够满足要求，一线发送一线接受避免了 inout 方向控制，同时有一个时钟总线连对时钟，避免了 UART 的时钟对照。同 时有使能信号，能够让 FPGA 端 提前进行准备。连接上直接使用 了 FPGA 和 ESP 连接的 QSPI 总 线中的其中 4 个接口。QSPI 接口 如图 6 所示。 

接口对应如下：

![image_5]({{ site.baseurl }}/assets/images/2019_2_3/image_5.png)

![image_6]({{ site.baseurl }}/assets/images/2019_2_3/image_6.png)

![image_7]({{ site.baseurl }}/assets/images/2019_2_3/image_7.png)

其中 ESP 端这的 CLK，MISO，MOSI 正好对应 ESP32 的硬件 SPI 中的 VSPI， 传输效率相对更高，而且更稳定。 

&nbsp;

**第三部分 完成情况及性能参数**

&nbsp;

具体完成的情况，可图文结合，具体的性能参数等量化指 

性能参数 

各个传感器采样周期：2s

ESP 与 FPGA 通信周期：2s

DHT11（温湿度传感器）性能参数：

温度测量范围：0~50℃ 

湿度测量范围：20~90% 

温度灵敏度：1℃ 

湿度灵敏度：1% 

GY30 性能参数： 

测量范围：1lux-65535lux 

灵敏度（本系统使用的高灵敏度模式）：1lux 

步进电机参数：导程 8mm，行程 550mm 

步进电机驱动器参数：800Pulse/rev 

稳压电源参数：24V 600W 

&nbsp;

**第四部分 总结**

&nbsp;

**4.1 主要创新点**

（1） 全创新屋盖内部结构 

（2） 智能气象判断 

（3） 六组单独控制，灵活适应环境

**4.2 可扩展之处** 

传感器灵敏度及采样周期；

更多样气象条件的监测； 

更智能化控制；

**4.3 心得体会**

从智能屋盖的每个结构的构思、建模，到 I2C 协议的学习、驱动，再到最后的组装 调试，本组三位成员都获益匪浅，所得经验教训都足够消化很久。当紧锣密鼓的 PLD 终 于暂时有了阶段性成果，基于 SEA 的智能屋盖开合系统也已经初步具备雏形，这无疑 是对我们最大的鼓励。

在模型运动体系建立上，结构部分将舵机构件视为刚体，未能够考虑到旋转轴的刚 表 1 SPI 总线接口 度太差，以及舵机自身转轴的偏差，导致模型实现情况会出现一定偏差，若通过二次建 模以合适的材料 3D 打印舵机的旋转轴，可以弥补舵机本身转轴刚度的问题，通过重新 设计舵机偏差的旋转轴在结构的安装位置，可以解决第一次开合成四面体的问题，但由 于经费问题，本次校赛不能够再次建模 3D 打印，希望在后面的深入设计中，可以通过 对不同型号舵机的分别调试实验，以及对 3D 建模打印尺寸的尝试，解决这些问题，同 时深入进行电子部分外观展示效果，比如在桁架网格薄板面上布置展开灯光效果、开合 提示音等，同时丰富传感部分，以实现更加多的智能控制部分。 

在舵机驱动上，我们走过不少弯路。舵机零件的牢度和转动角度的准确程度始终是 限制整个屋盖开合系统的因素；同种舵机在不同位置的每次转动速度的差别都有可能很 大程度影响实际观感的体验，这些都是我们需要一个个针对性调试的。此外，由于竞赛 初期错误估计了竞赛流程安排的紧凑，在电子方面一度陷入时间紧迫、质量低下的恶性 循环，足以引发我们日后的反思。如果能够在未来有充足的时间进行设计和升级，我们 将绝不会仅仅受限于题目，会综合利用更新更灵活的设计，以完成更实用美观的屋盖开 合系统。 

事实上，智能屋盖开合在当下已经有了许多实例，在未来也必将进入到千家万户。 这次竞赛里，我们仔细分析了许多案例，并在这一基础上综合创新，提出了自己的构想， 为这个方向提交了属于我们的一份答卷。

&nbsp;

**第五部分 参考文献**

&nbsp;

1. https://www.xilinx.com/support/documentation/ip_documentation/cordic/v6_0/pg105-cordic.pdf4

2. 体育场开合屋盖选型与设计要点_王斌

3. 开合屋盖机械系统设计研究及静力学分析_周良金

